function PCEINDEX(e,a){return 10*e+a}let GameBoard={};function CheckBoard(){let e,a,r,o,E=[0,0,0,0,0,0,0,0,0,0,0,0,0],B=[0,0];for(a=PIECES.wP;a<=PIECES.bK;++a)for(r=0;r<GameBoard.pceNum[a];++r)if(o=GameBoard.pList[PCEINDEX(a,r)],GameBoard.pieces[o]!=a)return console.log("Error Pce Lists"),BOOL.FALSE;for(e=0;e<64;++e)o=SQ120(e),E[a=GameBoard.pieces[o]]++,B[PieceCol[a]]+=PieceVal[a];for(a=PIECES.wP;a<=PIECES.bK;++a)if(E[a]!=GameBoard.pceNum[a])return console.log("Error t_pceNum"),BOOL.FALSE;return B[COLOURS.WHITE]!=GameBoard.material[COLOURS.WHITE]||B[COLOURS.BLACK]!=GameBoard.material[COLOURS.BLACK]?(console.log("Error t_material"),BOOL.FALSE):GameBoard.side!=COLOURS.WHITE&&GameBoard.side!=COLOURS.BLACK?(console.log("Error GameBoard.side"),BOOL.FALSE):GeneratePosKey()!=GameBoard.posKey?(console.log("Error GameBoard.posKey"),BOOL.FALSE):BOOL.TRUE}function PrintBoard(){let e,a,r,o;for(console.log("\nGame Board:\n"),r=RANKS.RANK_8;r>=RANKS.RANK_1;r--){let E=RankChar[r]+"  ";for(a=FILES.FILE_A;a<=FILES.FILE_H;a++)e=FR2SQ(a,r),o=GameBoard.pieces[e],E+=" "+PceChar[o]+" ";console.log(E)}for(console.log(""),E="   ",a=FILES.FILE_A;a<=FILES.FILE_H;a++)E+=" "+FileChar[a]+" ";console.log(E),console.log("side:"+SideChar[GameBoard.side]),console.log("enPas:"+GameBoard.enPas),E="",GameBoard.castlePerm&CASTLEBIT.WKCA&&(E+="K"),GameBoard.castlePerm&CASTLEBIT.WQCA&&(E+="Q"),GameBoard.castlePerm&CASTLEBIT.BKCA&&(E+="k"),GameBoard.castlePerm&CASTLEBIT.BQCA&&(E+="q"),console.log("castle:"+E),console.log("key:"+GameBoard.posKey.toString(16))}function GeneratePosKey(){let e=0,a=0,r=PIECES.EMPTY;for(e=0;e<BRD_SQ_NUM;++e)(r=GameBoard.pieces[e])!=PIECES.EMPTY&&r!=SQUARES.OFFBOARD&&(a^=PieceKeys[120*r+e]);return GameBoard.side==COLOURS.WHITE&&(a^=SideKey),GameBoard.enPas!=SQUARES.NO_SQ&&(a^=PieceKeys[GameBoard.enPas]),a^CastleKeys[GameBoard.castlePerm]}function PrintPieceLists(){let e,a;for(e=PIECES.wP;e<=PIECES.bK;++e)for(a=0;a<GameBoard.pceNum[e];++a)console.log("Piece "+PceChar[e]+" on "+PrSq(GameBoard.pList[PCEINDEX(e,a)]))}function UpdateListsMaterial(){let e,a,r,o;for(r=0;r<1680;++r)GameBoard.pList[r]=PIECES.EMPTY;for(r=0;r<2;++r)GameBoard.material[r]=0;for(r=0;r<13;++r)GameBoard.pceNum[r]=0;for(r=0;r<64;++r)a=SQ120(r),(e=GameBoard.pieces[a])!=PIECES.EMPTY&&(o=PieceCol[e],GameBoard.material[o]+=PieceVal[e],GameBoard.pList[PCEINDEX(e,GameBoard.pceNum[e])]=a,GameBoard.pceNum[e]++)}function ResetBoard(){let e=0;for(e=0;e<BRD_SQ_NUM;++e)GameBoard.pieces[e]=SQUARES.OFFBOARD;for(e=0;e<64;++e)GameBoard.pieces[SQ120(e)]=PIECES.EMPTY;GameBoard.side=COLOURS.BOTH,GameBoard.enPas=SQUARES.NO_SQ,GameBoard.fiftyMove=0,GameBoard.ply=0,GameBoard.hisPly=0,GameBoard.castlePerm=0,GameBoard.posKey=0,GameBoard.moveListStart[GameBoard.ply]=0}function ParseFen(e){ResetBoard();for(var a=RANKS.RANK_8,r=FILES.FILE_A,o=0,E=0,B=0,s=0,c=0;a>=RANKS.RANK_1&&c<e.length;){switch(E=1,e[c]){case"p":o=PIECES.bP;break;case"r":o=PIECES.bR;break;case"n":o=PIECES.bN;break;case"b":o=PIECES.bB;break;case"k":o=PIECES.bK;break;case"q":o=PIECES.bQ;break;case"P":o=PIECES.wP;break;case"R":o=PIECES.wR;break;case"N":o=PIECES.wN;break;case"B":o=PIECES.wB;break;case"K":o=PIECES.wK;break;case"Q":o=PIECES.wQ;break;case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":o=PIECES.EMPTY,E=e[c].charCodeAt()-"0".charCodeAt();break;case"/":case" ":a--,r=FILES.FILE_A,c++;continue;default:return void console.log("FEN error")}for(B=0;B<E;B++)s=FR2SQ(r,a),GameBoard.pieces[s]=o,r++;c++}for(GameBoard.side="w"==e[c]?COLOURS.WHITE:COLOURS.BLACK,c+=2,B=0;B<4&&" "!=e[c];B++){switch(e[c]){case"K":GameBoard.castlePerm|=CASTLEBIT.WKCA;break;case"Q":GameBoard.castlePerm|=CASTLEBIT.WQCA;break;case"k":GameBoard.castlePerm|=CASTLEBIT.BKCA;break;case"q":GameBoard.castlePerm|=CASTLEBIT.BQCA}c++}"-"!=e[++c]&&(r=e[c].charCodeAt()-"a".charCodeAt(),a=e[c+1].charCodeAt()-"1".charCodeAt(),console.log("fen[fenCnt]:"+e[c]+" File:"+r+" Rank:"+a),GameBoard.enPas=FR2SQ(r,a)),GameBoard.posKey=GeneratePosKey(),UpdateListsMaterial()}function PrintSqAttacked(){let e,a;for(console.log("\nAttacked:\n"),a=RANKS.RANK_8;a>=RANKS.RANK_1;a--){let r=a+1+"  ";for(e=FILES.FILE_A;e<=FILES.FILE_H;e++)r+=" "+(SqAttacked(FR2SQ(e,a),1^GameBoard.side)==BOOL.TRUE?"X":"-")+" ";console.log(r)}console.log("")}function SqAttacked(e,a){let r,o,E;if(a==COLOURS.WHITE){if(GameBoard.pieces[e-11]==PIECES.wP||GameBoard.pieces[e-9]==PIECES.wP)return BOOL.TRUE}else if(GameBoard.pieces[e+11]==PIECES.bP||GameBoard.pieces[e+9]==PIECES.bP)return BOOL.TRUE;for(E=0;E<8;E++)if((r=GameBoard.pieces[e+KnDir[E]])!=SQUARES.OFFBOARD&&PieceCol[r]==a&&PieceKnight[r]==BOOL.TRUE)return BOOL.TRUE;for(E=0;E<4;++E)for(dir=RkDir[E],o=e+dir,r=GameBoard.pieces[o];r!=SQUARES.OFFBOARD;){if(r!=PIECES.EMPTY){if(PieceRookQueen[r]==BOOL.TRUE&&PieceCol[r]==a)return BOOL.TRUE;break}o+=dir,r=GameBoard.pieces[o]}for(E=0;E<4;++E)for(dir=BiDir[E],o=e+dir,r=GameBoard.pieces[o];r!=SQUARES.OFFBOARD;){if(r!=PIECES.EMPTY){if(PieceBishopQueen[r]==BOOL.TRUE&&PieceCol[r]==a)return BOOL.TRUE;break}o+=dir,r=GameBoard.pieces[o]}for(E=0;E<8;E++)if((r=GameBoard.pieces[e+KiDir[E]])!=SQUARES.OFFBOARD&&PieceCol[r]==a&&PieceKing[r]==BOOL.TRUE)return BOOL.TRUE;return BOOL.FALSE}GameBoard.pieces=new Array(BRD_SQ_NUM),GameBoard.side=COLOURS.WHITE,GameBoard.fiftyMove=0,GameBoard.hisPly=0,GameBoard.history=[],GameBoard.ply=0,GameBoard.enPas=0,GameBoard.castlePerm=0,GameBoard.material=new Array(2),GameBoard.pceNum=new Array(13),GameBoard.pList=new Array(140),GameBoard.posKey=0,GameBoard.moveList=new Array(MAXDEPTH*MAXPOSITIONMOVES),GameBoard.moveScores=new Array(MAXDEPTH*MAXPOSITIONMOVES),GameBoard.moveListStart=new Array(MAXDEPTH),GameBoard.PvTable=[],GameBoard.Pletray=new Array(MAXDEPTH),GameBoard.searchHistory=new Array(14*BRD_SQ_NUM),GameBoard.searchKillers=new Array(3*MAXDEPTH);